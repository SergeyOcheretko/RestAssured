name: RestAssured API Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: ü™Ñ Clone gh-pages to get previous history
        continue-on-error: true
        run: |
          git config --global user.email "github-actions@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          git clone --depth=1 --branch=gh-pages https://github.com/${{ github.repository }} gh-pages-copy || echo "‚ö†Ô∏è gh-pages branch not found"

      - name: üìÇ Copy history into results (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path target\allure-results\history | Out-Null
          if (Test-Path "gh-pages-copy\history") {
            Copy-Item -Path "gh-pages-copy\history\*" -Destination "target\allure-results\history" -Recurse -Force
          } else {
            Write-Output "üì≠ –ò—Å—Ç–æ—Ä–∏—è –∏–∑ gh-pages –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          }


      - name: üß™ Run tests
        run: mvn clean test

      - name: üß¨ Add Allure metadata
        run: |
          mkdir -p target/allure-results
          echo '{
            "name": "GitHub Actions",
            "type": "github",
            "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "buildName": "${{ github.workflow }}",
            "buildOrder": "${{ github.run_number }}",
            "buildUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' > target/allure-results/executor.json

          echo "CI=GitHub Actions" > target/allure-results/environment.properties
          echo "OS=ubuntu-latest" >> target/allure-results/environment.properties
          echo "Java=17" >> target/allure-results/environment.properties

      - name: üìä Generate Allure report
        run: |
          npm install -g allure-commandline --force
          allure generate target/allure-results --clean -o target/allure-report

      - name: üì¨ Telegram notification
        run: |
          COUNT=$(find target/allure-results -type f | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            TEXT="‚ö†Ô∏è RestAssuredTests ‚Äî —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞, –Ω–æ Allure-–æ—Ç—á—ë—Ç –ø—É—Å—Ç"
          else
            TEXT="‚úÖ RestAssuredTests ‚Äî —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
          fi

          curl -s -X POST "https://api.telegram.org/bot7061709468:AAG58ymjWRKuDFQc8zTH6t7FgYZFTeVlYhw/sendMessage" \
            -d chat_id=488207930 \
            -d parse_mode=HTML \
            --data-urlencode "text=$TEXT" \
            --data-urlencode "reply_markup={
              \"inline_keyboard\": [[
                {\"text\": \"üìä –°–º–æ—Ç—Ä–µ—Ç—å Allure-–æ—Ç—á—ë—Ç\", \"url\": \"https://sergeyocheretko.github.io/RestAssured/\"}
              ]]
            }"

      - name: üöÄ Deploy to GitHub Pages (preserves trend)
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: target/allure-report
          force_orphan: true

